<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„ÅäÈáë„ÅÆË≤∏„ÅóÂÄü„ÇäÁÆ°ÁêÜ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: #ffffff;
        }

        .login-box {
            background: white;
            padding: 50px 30px;
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid #f3f4f6;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 32px;
        }

        .login-box h1 {
            font-size: 28px;
            color: #111827;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .login-box p {
            color: #6b7280;
            margin-bottom: 40px;
            font-size: 15px;
            line-height: 1.6;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 18px 24px;
            background: #111827;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .google-login-btn:hover {
            background: #1f2937;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .google-login-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: env(safe-area-inset-top, 0) 20px 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 15px;
            margin-top: 15px;
            font-weight: 600;
        }

        .user-info {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .balance {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            margin-top: 10px;
            backdrop-filter: blur(10px);
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 700;
            margin-top: 8px;
            letter-spacing: -0.5px;
        }

        .balance-label {
            font-size: 13px;
            opacity: 0.95;
        }

        .form-section {
            padding: 20px;
            border-bottom: 8px solid #f5f5f5;
            flex-shrink: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            background: #f9fafb;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: none;
            min-height: 80px;
            font-family: inherit;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 16px 12px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.96);
        }

        .btn-lend {
            background: #10b981;
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .btn-lend:active {
            box-shadow: 0 1px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-borrow {
            background: #ef4444;
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
        }

        .btn-borrow:active {
            box-shadow: 0 1px 4px rgba(239, 68, 68, 0.3);
        }

        .btn-repay {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
        }

        .btn-repay:active {
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.3);
        }

        .history-section {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .history-section h2 {
            margin-bottom: 16px;
            color: #111827;
            font-size: 18px;
            font-weight: 600;
        }

        .history-list {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .history-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #f3f4f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .history-item.lend {
            border-left: 5px solid #10b981;
        }

        .history-item.borrow {
            border-left: 5px solid #ef4444;
        }

        .history-item.repay {
            border-left: 5px solid #3b82f6;
        }

        .history-info {
            flex: 1;
            min-width: 0;
        }

        .history-type {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .history-type.lend {
            color: #10b981;
        }

        .history-type.borrow {
            color: #ef4444;
        }

        .history-type.repay {
            color: #3b82f6;
        }

        .history-description {
            color: #374151;
            font-size: 15px;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .history-date {
            color: #9ca3af;
            font-size: 13px;
        }

        .history-by {
            color: #6b7280;
            font-size: 12px;
            margin-top: 2px;
        }

        .history-amount {
            font-size: 22px;
            font-weight: 700;
            margin-left: 12px;
            flex-shrink: 0;
            letter-spacing: -0.5px;
        }

        .history-amount.lend {
            color: #10b981;
        }

        .history-amount.borrow {
            color: #ef4444;
        }

        .history-amount.repay {
            color: #3b82f6;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
            font-size: 15px;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 12px;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .delete-btn:active {
            transform: scale(0.95);
            background: #dc2626;
        }

        .dashboard-section {
            padding: 20px;
            background: #f9fafb;
            border-bottom: 8px solid #e5e7eb;
        }

        .dashboard-section h2 {
            margin-bottom: 16px;
            color: #111827;
            font-size: 18px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 2px solid #f3f4f6;
        }

        .stat-card.highlight {
            border: 2px solid #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.5px;
        }

        .stat-value.positive {
            color: #10b981;
        }

        .stat-value.negative {
            color: #ef4444;
        }

        .user-stats {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 2px solid #f3f4f6;
        }

        .user-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .user-stat-row:last-child {
            border-bottom: none;
        }

        .user-stat-info {
            flex: 1;
        }

        .user-stat-name {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .user-stat-detail {
            font-size: 12px;
            color: #9ca3af;
        }

        .user-stat-amount {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .footer {
            padding: 30px 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
            text-align: center;
            border-top: 1px solid #e5e7eb;
            background: #fafafa;
        }

        .logout-link {
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
        }

        .logout-link:active {
            color: #374151;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-height: 85vh;
            border-radius: 24px 24px 0 0;
            padding: 24px 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .modal-close {
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:active {
            background: #e5e7eb;
        }

        .repay-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .repay-item.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .repay-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #667eea;
        }

        .repay-info {
            flex: 1;
            min-width: 0;
        }

        .repay-description {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .repay-date {
            font-size: 13px;
            color: #9ca3af;
        }

        .repay-amount {
            font-size: 18px;
            font-weight: 700;
            color: #ef4444;
            flex-shrink: 0;
        }

        .repay-summary {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px 0;
            border-top: 2px solid #e5e7eb;
            margin-top: 20px;
        }

        .repay-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .repay-total-label {
            font-size: 16px;
            color: #6b7280;
        }

        .repay-total-amount {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
        }

        .btn-repay-confirm {
            width: 100%;
            padding: 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-repay-confirm:disabled {
            background: #d1d5db;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-repay-confirm:not(:disabled):active {
            transform: scale(0.98);
        }

        .empty-repay {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-icon">üí∞</div>
            <h1>„ÅäÈáë„ÅÆË≤∏„ÅóÂÄü„ÇäÁÆ°ÁêÜ</h1>
            <p>Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <button class="google-login-btn" onclick="signInWithGoogle()">
                <svg class="google-icon" viewBox="0 0 20 20">
                    <path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
                    <path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
                    <path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
                    <path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
                </svg>
                Google„Åß„É≠„Ç∞„Ç§„É≥
            </button>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ÁîªÈù¢ -->
    <div id="appScreen" class="container hidden">
        <div class="header">
            <h1>„ÅäÈáë„ÅÆË≤∏„ÅóÂÄü„ÇäÁÆ°ÁêÜ</h1>
            <div class="user-info" id="userInfo"></div>
            <div class="balance">
                <div class="balance-label">ÁèæÂú®„ÅÆÂèéÊîØ</div>
                <div class="balance-amount" id="balanceAmount">¬•0</div>
                <div class="balance-label" id="balanceStatus"></div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="amount">ÈáëÈ°ç</label>
                <input type="number" id="amount" placeholder="‰æã: 5000" min="0">
            </div>

            <div class="form-group">
                <label for="description">Ë™¨Êòé</label>
                <textarea id="description" placeholder="‰æã: „É©„É≥„ÉÅ‰ª£"></textarea>
            </div>

            <div class="form-group">
                <label for="date">Êó•‰ªò</label>
                <input type="date" id="date">
            </div>

            <div class="button-group">
                <button class="btn-lend" onclick="addTransaction('lend')">Ë≤∏„Åó„Åü</button>
                <button class="btn-borrow" onclick="addTransaction('borrow')">ÂÄü„Çä„Åü</button>
                <button class="btn-repay" onclick="openRepayModal()">Ëøî„Åô</button>
            </div>
        </div>

        <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
        <div class="dashboard-section">
            <h2>Ë©≥Á¥∞</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Ë≤∏„Åó„ÅüÂêàË®à</div>
                    <div class="stat-value positive" id="totalLent">¬•0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÂÄü„Çä„ÅüÂêàË®à</div>
                    <div class="stat-value negative" id="totalBorrowed">¬•0</div>
                </div>
            </div>

            <div class="user-stats" id="userStats">
                <div class="user-stat-row">
                    <div class="user-stat-info">
                        <div class="user-stat-name">„É¶„Éº„Ç∂„Éº1</div>
                        <div class="user-stat-detail">Ë≤∏: ¬•0 / ÂÄü: ¬•0</div>
                    </div>
                    <div class="user-stat-amount">¬•0</div>
                </div>
            </div>
        </div>

        <div class="history-section">
            <h2>Â±•Ê≠¥</h2>
            <div class="history-list" id="historyList">
                <div class="empty-state">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
        </div>

        <div class="footer">
            <a class="logout-link" onclick="signOut()">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
        </div>
    </div>

    <!-- ËøîÊ∏à„É¢„Éº„ÉÄ„É´ -->
    <div id="repayModal" class="modal hidden" onclick="closeRepayModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">ËøîÊ∏à„Åô„Çã</div>
                <button class="modal-close" onclick="closeRepayModal()">√ó</button>
            </div>

            <div id="repayList"></div>

            <div class="repay-summary">
                <div class="repay-total">
                    <div class="repay-total-label">ËøîÊ∏àÈ°ç</div>
                    <div class="repay-total-amount" id="repayTotalAmount">¬•0</div>
                </div>
                <button class="btn-repay-confirm" id="repayConfirmBtn" disabled onclick="confirmRepay()">
                    ËøîÊ∏à„ÇíÁ¢∫ÂÆö
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
        // ===== SupabaseË®≠ÂÆö =====
        const SUPABASE_URL = 'https://tfqmtfoqhnujussznkid.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmcW10Zm9xaG51anVzc3pua2lkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjQ1MDMsImV4cCI6MjA4MzI0MDUwM30.SzfOchvXdnO-HIpuoweYoAZaezbE9Kv0Echs7w1Dchc';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let transactions = [];

        // ===== Ë™çË®ºÈñ¢ÈÄ£ =====
        async function signInWithGoogle() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'https://optflex.github.io/money-with-serena/'
                }
            });

            if (error) {
                console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                alert('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        async function signOut() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„Åã?')) {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
                } else {
                    location.reload();
                }
            }
        }

        async function checkAllowedEmail(email) {
            const { data, error } = await supabaseClient
                .from('allowed_emails')
                .select('email')
                .eq('email', email)
                .single();

            if (error || !data) {
                await supabaseClient.auth.signOut();
                alert('„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØ„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                location.reload();
                return false;
            }

            return true;
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `${currentUser.email}`;
            loadTransactions();
        }

        // ===== „Éá„Éº„ÇøÈñ¢ÈÄ£ =====
        async function loadTransactions() {
            const { data, error } = await supabaseClient
                .from('transactions')
                .select('*')
                .order('date', { ascending: false });

            if (error) {
                console.error('„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÂèñÂæó„Ç®„É©„Éº:', error);
                transactions = [];
            } else {
                transactions = data || [];
            }

            updateBalance();
            updateDashboard();
            renderHistory();
        }

        function setDefaultDate() {
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }

        function updateBalance() {
            // „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆË¶ñÁÇπ„ÅßË®àÁÆó
            const myEmail = currentUser.email;

            // Ëá™ÂàÜ„ÅåË≤∏„Åó„Åü = Ëá™ÂàÜ„ÅåÁôªÈå≤„Åó„Åülend + Áõ∏Êâã„ÅåÁôªÈå≤„Åó„Åüborrow
            const myLent = transactions
                .filter(t =>
                    (t.user_email === myEmail && t.type === 'lend') ||
                    (t.user_email !== myEmail && t.type === 'borrow')
                )
                .reduce((sum, t) => sum + t.amount, 0);

            // Ëá™ÂàÜ„ÅåÂÄü„Çä„Åü = Ëá™ÂàÜ„ÅåÁôªÈå≤„Åó„Åüborrow + Áõ∏Êâã„ÅåÁôªÈå≤„Åó„Åülend
            const myBorrowed = transactions
                .filter(t =>
                    (t.user_email === myEmail && t.type === 'borrow') ||
                    (t.user_email !== myEmail && t.type === 'lend')
                )
                .reduce((sum, t) => sum + t.amount, 0);

            // Ëá™ÂàÜ„ÅåËøîÊ∏à„Åó„ÅüÈáëÈ°çÔºàËá™ÂàÜ„ÅÆÂÄü„Çä„ÇíÊ∏õ„Çâ„ÅôÔºâ
            const myRepaid = transactions
                .filter(t => t.user_email === myEmail && t.type === 'repay')
                .reduce((sum, t) => sum + t.amount, 0);

            // Áõ∏Êâã„ÅåËøîÊ∏à„Åó„ÅüÈáëÈ°çÔºàÁõ∏Êâã„ÅÆÂÄü„Çä„ÇíÊ∏õ„Çâ„Åô = Ëá™ÂàÜ„ÅÆË≤∏„Åó„ÇíÊ∏õ„Çâ„ÅôÔºâ
            const theirRepaid = transactions
                .filter(t => t.user_email !== myEmail && t.type === 'repay')
                .reduce((sum, t) => sum + t.amount, 0);

            // ÂèéÊîØ = Ë≤∏„Åó„Åü - ÂÄü„Çä„Åü + Ëá™ÂàÜ„ÅåËøîÊ∏à„Åó„Åü - Áõ∏Êâã„ÅåËøîÊ∏à„Åó„Åü
            const balance = myLent - myBorrowed + myRepaid - theirRepaid;

            const balanceElement = document.getElementById('balanceAmount');
            const statusElement = document.getElementById('balanceStatus');

            balanceElement.textContent = `¬•${balance.toLocaleString()}`;

            if (balance > 0) {
                statusElement.textContent = 'Áõ∏Êâã„ÅåÂÄü„Çä„Å¶„ÅÑ„Çã';
            } else if (balance < 0) {
                statusElement.textContent = 'Ëá™ÂàÜ„ÅåÂÄü„Çä„Å¶„ÅÑ„Çã';
            } else {
                statusElement.textContent = 'Ë≤∏„ÅóÂÄü„Çä„Å™„Åó';
            }
        }

        function updateDashboard() {
            // „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆË¶ñÁÇπ„ÅßË®àÁÆó
            const myEmail = currentUser.email;

            // Ëá™ÂàÜ„ÅåË≤∏„Åó„Åü = Ëá™ÂàÜ„ÅåÁôªÈå≤„Åó„Åülend + Áõ∏Êâã„ÅåÁôªÈå≤„Åó„Åüborrow
            const myLent = transactions
                .filter(t =>
                    (t.user_email === myEmail && t.type === 'lend') ||
                    (t.user_email !== myEmail && t.type === 'borrow')
                )
                .reduce((sum, t) => sum + t.amount, 0);

            // Ëá™ÂàÜ„ÅåÂÄü„Çä„Åü = Ëá™ÂàÜ„ÅåÁôªÈå≤„Åó„Åüborrow + Áõ∏Êâã„ÅåÁôªÈå≤„Åó„Åülend
            const myBorrowed = transactions
                .filter(t =>
                    (t.user_email === myEmail && t.type === 'borrow') ||
                    (t.user_email !== myEmail && t.type === 'lend')
                )
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('totalLent').textContent = `¬•${myLent.toLocaleString()}`;
            document.getElementById('totalBorrowed').textContent = `¬•${myBorrowed.toLocaleString()}`;

            // „É¶„Éº„Ç∂„Éº„Åî„Å®„ÅÆÁµ±Ë®à
            const userStatsMap = {};

            transactions.forEach(t => {
                if (!userStatsMap[t.user_email]) {
                    userStatsMap[t.user_email] = {
                        email: t.user_email,
                        lent: 0,
                        borrowed: 0,
                        repaid: 0
                    };
                }

                if (t.type === 'lend') {
                    userStatsMap[t.user_email].lent += t.amount;
                } else if (t.type === 'borrow') {
                    userStatsMap[t.user_email].borrowed += t.amount;
                } else if (t.type === 'repay') {
                    userStatsMap[t.user_email].repaid += t.amount;
                }
            });

            const userStatsArray = Object.values(userStatsMap);
            const userStatsContainer = document.getElementById('userStats');

            if (userStatsArray.length === 0) {
                userStatsContainer.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            userStatsContainer.innerHTML = userStatsArray.map(user => {
                // „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆË¶ñÁÇπ„ÅßË®àÁÆó
                let displayLent, displayBorrowed, displayRepaid, netBalance;

                if (user.email === myEmail) {
                    // Ëá™ÂàÜ„ÅÆÁµ±Ë®à
                    displayLent = user.lent;
                    displayBorrowed = user.borrowed;
                    displayRepaid = user.repaid;
                    // Áõ∏Êâã„ÅÆËøîÊ∏à„ÇíÂèñÂæó
                    const theirRepaid = Object.values(userStatsMap)
                        .filter(u => u.email !== myEmail)
                        .reduce((sum, u) => sum + u.repaid, 0);
                    netBalance = user.lent - user.borrowed + user.repaid - theirRepaid;
                } else {
                    // Áõ∏Êâã„ÅÆÁµ±Ë®à„ÅØÈÄÜËª¢
                    displayLent = user.borrowed;  // Áõ∏Êâã„ÅåÂÄü„Çä„Åü = Ëá™ÂàÜ„ÅåË≤∏„Åó„Åü
                    displayBorrowed = user.lent;  // Áõ∏Êâã„ÅåË≤∏„Åó„Åü = Ëá™ÂàÜ„ÅåÂÄü„Çä„Åü
                    displayRepaid = 0;  // Áõ∏Êâã„ÅÆËøîÊ∏à„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºàË§áÈõë„Å´„Å™„Çã„ÅÆ„ÅßÔºâ
                    // Ëá™ÂàÜ„ÅÆËøîÊ∏à„ÇíÂèñÂæó
                    const myRepaid = userStatsMap[myEmail] ? userStatsMap[myEmail].repaid : 0;
                    netBalance = user.borrowed - user.lent - myRepaid + user.repaid;
                }

                const userName = user.email.split('@')[0];

                let statusText = '';
                let amountClass = '';
                let amountText = '';

                if (netBalance > 0) {
                    statusText = 'Áõ∏Êâã„ÅåÂÄü„Çä„Å¶„ÅÑ„Çã';
                    amountClass = 'positive';
                    amountText = `+¬•${netBalance.toLocaleString()}`;
                } else if (netBalance < 0) {
                    statusText = 'Ëá™ÂàÜ„ÅåÂÄü„Çä„Å¶„ÅÑ„Çã';
                    amountClass = 'negative';
                    amountText = `-¬•${Math.abs(netBalance).toLocaleString()}`;
                } else {
                    statusText = 'Ë≤∏„ÅóÂÄü„Çä„Å™„Åó';
                    amountText = '¬•0';
                }

                return `
                    <div class="user-stat-row">
                        <div class="user-stat-info">
                            <div class="user-stat-name">${escapeHtml(userName)}</div>
                            <div class="user-stat-detail">Ë≤∏: ¬•${displayLent.toLocaleString()} / ÂÄü: ¬•${displayBorrowed.toLocaleString()}${displayRepaid > 0 ? ` / ËøîÊ∏à: ¬•${displayRepaid.toLocaleString()}` : ''}</div>
                            <div class="user-stat-detail" style="margin-top: 2px; color: #6b7280;">${statusText}</div>
                        </div>
                        <div class="user-stat-amount ${amountClass}">${amountText}</div>
                    </div>
                `;
            }).join('');
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');

            if (transactions.length === 0) {
                historyList.innerHTML = '<div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            const sortedTransactions = [...transactions].sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            historyList.innerHTML = sortedTransactions.map((t) => {
                let typeLabel = '';
                let amountSign = '';

                if (t.type === 'lend') {
                    typeLabel = 'Ë≤∏„Åó„Åü';
                    amountSign = '+';
                } else if (t.type === 'borrow') {
                    typeLabel = 'ÂÄü„Çä„Åü';
                    amountSign = '-';
                } else if (t.type === 'repay') {
                    typeLabel = 'ËøîÊ∏à';
                    amountSign = '+';
                }

                return `
                    <div class="history-item ${t.type}">
                        <div class="history-info">
                            <div class="history-type ${t.type}">
                                ${typeLabel}
                            </div>
                            <div class="history-description">${escapeHtml(t.description)}</div>
                            <div class="history-date">${formatDate(t.date)}</div>
                            <div class="history-by">ÁôªÈå≤ËÄÖ: ${t.user_email.split('@')[0]}</div>
                        </div>
                        <div class="history-amount ${t.type}">
                            ${amountSign}¬•${t.amount.toLocaleString()}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction('${t.id}')">ÂâäÈô§</button>
                    </div>
                `;
            }).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function addTransaction(type) {
            const amount = parseInt(document.getElementById('amount').value);
            const description = document.getElementById('description').value.trim();
            const date = document.getElementById('date').value;

            if (!amount || amount <= 0) {
                alert('ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!description) {
                alert('Ë™¨Êòé„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!date) {
                alert('Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const transaction = {
                user_email: currentUser.email,
                type,
                amount,
                description,
                date,
                repaid: type === 'borrow' ? false : null
            };

            const { error } = await supabaseClient
                .from('transactions')
                .insert([transaction]);

            if (error) {
                console.error('„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ËøΩÂä†„Ç®„É©„Éº:', error);
                alert('Ë®òÈå≤„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                return;
            }

            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            setDefaultDate();

            await loadTransactions();
        }

        async function deleteTransaction(id) {
            if (confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
                const transaction = transactions.find(t => t.id === id);

                // ËøîÊ∏à„ÇíÂâäÈô§„Åô„ÇãÂ†¥Âêà„ÄÅÁ¥ê‰ªò„Åë„Çâ„Çå„ÅüÂÄü„Çä„ÇíÊú™ËøîÊ∏à„Å´Êàª„Åô
                if (transaction && transaction.type === 'repay' && transaction.repaid_transactions) {
                    const { error: updateError } = await supabaseClient
                        .from('transactions')
                        .update({ repaid: false })
                        .in('id', transaction.repaid_transactions);

                    if (updateError) {
                        console.error('ÂÄü„ÇäÊõ¥Êñ∞„Ç®„É©„Éº:', updateError);
                    }
                }

                const { error } = await supabaseClient
                    .from('transactions')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÂâäÈô§„Ç®„É©„Éº:', error);
                    alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    return;
                }

                await loadTransactions();
            }
        }

        // ===== ËøîÊ∏àÈñ¢ÈÄ£ =====
        let selectedRepayItems = new Set();

        function openRepayModal() {
            // ÂÄü„Çä„Å¶„ÅÑ„Çã„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„ÅÆ„Åø„ÇíÂèñÂæóÔºàËøîÊ∏àÊ∏à„Åø„ÇíÈô§Â§ñÔºâ
            const borrowedTransactions = transactions.filter(t => t.type === 'borrow' && !t.repaid);

            const repayList = document.getElementById('repayList');

            if (borrowedTransactions.length === 0) {
                repayList.innerHTML = '<div class="empty-repay">ËøîÊ∏à„Åô„ÇãÂÄü„Çä„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            } else {
                repayList.innerHTML = borrowedTransactions.map(t => `
                    <div class="repay-item" id="repay-item-${t.id}">
                        <input
                            type="checkbox"
                            class="repay-checkbox"
                            id="checkbox-${t.id}"
                            onchange="toggleRepayItem('${t.id}')"
                        >
                        <div class="repay-info">
                            <div class="repay-description">${escapeHtml(t.description)}</div>
                            <div class="repay-date">${formatDate(t.date)}</div>
                        </div>
                        <div class="repay-amount">¬•${t.amount.toLocaleString()}</div>
                    </div>
                `).join('');
            }

            selectedRepayItems.clear();
            updateRepayTotal();
            document.getElementById('repayModal').classList.remove('hidden');
        }

        function closeRepayModal() {
            document.getElementById('repayModal').classList.add('hidden');
            selectedRepayItems.clear();
        }

        function toggleRepayItem(id) {
            const checkbox = document.getElementById(`checkbox-${id}`);
            const item = document.getElementById(`repay-item-${id}`);

            if (checkbox.checked) {
                selectedRepayItems.add(id);
                item.classList.add('selected');
            } else {
                selectedRepayItems.delete(id);
                item.classList.remove('selected');
            }

            updateRepayTotal();
        }

        function updateRepayTotal() {
            const total = Array.from(selectedRepayItems).reduce((sum, id) => {
                const transaction = transactions.find(t => t.id === id);
                return sum + (transaction ? transaction.amount : 0);
            }, 0);

            document.getElementById('repayTotalAmount').textContent = `¬•${total.toLocaleString()}`;
            document.getElementById('repayConfirmBtn').disabled = total === 0;
        }

        async function confirmRepay() {
            if (selectedRepayItems.size === 0) return;

            const repayedIds = Array.from(selectedRepayItems);
            const total = repayedIds.reduce((sum, id) => {
                const transaction = transactions.find(t => t.id === id);
                return sum + (transaction ? transaction.amount : 0);
            }, 0);

            // ÈÅ∏Êäû„Åï„Çå„ÅüÂÄü„Çä„Çí„ÄåËøîÊ∏àÊ∏à„Åø„Äç„Å´„Éû„Éº„ÇØ
            const { error: updateError } = await supabaseClient
                .from('transactions')
                .update({ repaid: true })
                .in('id', repayedIds);

            if (updateError) {
                console.error('ÂÄü„ÇäÊõ¥Êñ∞„Ç®„É©„Éº:', updateError);
                alert('ËøîÊ∏àÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + updateError.message);
                return;
            }

            // ËøîÊ∏àË®òÈå≤„ÇíËøΩÂä†Ôºàtype: 'repay'Ôºâ
            const repayTransaction = {
                user_email: currentUser.email,
                type: 'repay',
                amount: total,
                description: 'ËøîÊ∏à',
                date: new Date().toISOString().split('T')[0],
                repaid_transactions: repayedIds // „Å©„ÅÆÂÄü„Çä„ÇíËøî„Åó„Åü„ÅãË®òÈå≤
            };

            const { error: insertError } = await supabaseClient
                .from('transactions')
                .insert([repayTransaction]);

            if (insertError) {
                console.error('ËøîÊ∏àË®òÈå≤ËøΩÂä†„Ç®„É©„Éº:', insertError);
                alert('ËøîÊ∏àË®òÈå≤„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + insertError.message);
                return;
            }

            await loadTransactions();
            closeRepayModal();
        }

        // ===== ÂàùÊúüÂåñ =====
        async function initialize() {
            // Ë™çË®ºÁä∂ÊÖã„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    const user = session.user;

                    // „Éõ„ÉØ„Ç§„Éà„É™„Çπ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
                    const isAllowed = await checkAllowedEmail(user.email);
                    if (!isAllowed) return;

                    currentUser = { email: user.email };
                    setDefaultDate();
                    showApp();
                } else if (event === 'SIGNED_OUT') {
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('appScreen').classList.add('hidden');
                    currentUser = null;
                    transactions = [];
                }
            });

            // ÂàùÂõûË™≠„ÅøËæº„ÅøÊôÇ„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (session) {
                const user = session.user;

                // „Éõ„ÉØ„Ç§„Éà„É™„Çπ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
                const isAllowed = await checkAllowedEmail(user.email);
                if (!isAllowed) return;

                currentUser = { email: user.email };
                setDefaultDate();
                showApp();
            } else {
                // Êú™„É≠„Ç∞„Ç§„É≥„ÅÆÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        }

        // „Ç¢„Éó„É™Ëµ∑Âãï
        initialize();
    </script>
</body>
</html>
